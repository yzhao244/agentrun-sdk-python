name: CI

on:
  # ä»…åœ¨ push æ—¶è§¦å‘æµ‹è¯•
  push:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºå¢é‡è¦†ç›–ç‡æ£€æŸ¥

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        make setup PYTHON_VERSION=${{ matrix.python-version }}

    - name: Run type check (mypy)
      run: |
        make mypy-check

    - name: Run tests with coverage
      run: |
        make coverage

    - name: Run minimal installation test
      run: |
        # åˆ›å»ºä¸€ä¸ªä¸´æ—¶ç›®å½•ç”¨äºæµ‹è¯•
        mkdir -p /tmp/minimal_test
        cd /tmp/minimal_test
        
        # ä½¿ç”¨ uv åˆ›å»ºä¸€ä¸ªæ–°ç¯å¢ƒå¹¶åªå®‰è£…é¡¹ç›®çš„é»˜è®¤ä¾èµ–
        python -m uv venv --seed
        source .venv/bin/activate
        
        # å®‰è£…é¡¹ç›®ä½†ä¸åŒ…å«ä»»ä½•å¯é€‰ä¾èµ–
        python -m uv pip install "$GITHUB_WORKSPACE/.[]."
        
        # æµ‹è¯•å¯¼å…¥å’Œç‰ˆæœ¬æ‰“å°
        python -c "import agentrun; print(f'Version: {agentrun.__version__}')"

    # æ£€æµ‹æ–‡ä»¶æ›´æ”¹å¹¶å†³å®šæ˜¯å¦æ„å»ºæµ‹è¯•åŒ…
    - name: Check for changes in agentrun directory
      id: changes
      run: |
        echo "Checking if agentrun directory has changes..."
        # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤ä¹‹é—´çš„å·®å¼‚ï¼›å¦‚æœæ²¡æœ‰çˆ¶æäº¤ï¼Œåˆ™å°†æ‰€æœ‰è·Ÿè¸ªæ–‡ä»¶è§†ä¸ºå·²æ›´æ”¹
        if git rev-parse HEAD^ >/dev/null 2>&1; then
          git diff --name-only HEAD^ HEAD > changed_files.txt
        else
          echo "No parent commit; treating all tracked files as changed."
          git ls-files > changed_files.txt
        fi
        echo "Changed files:"
        cat changed_files.txt || echo "No changed files detected"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•ä»¥ agentrun/ å¼€å¤´çš„æ–‡ä»¶
        if grep -q "^agentrun/" changed_files.txt 2>/dev/null; then
          echo "agentrun directory has changes"
          echo "agentrun_changed=true" >> $GITHUB_OUTPUT
        else
          echo "agentrun directory has no changes"
          echo "agentrun_changed=false" >> $GITHUB_OUTPUT
        fi

    # æµ‹è¯•é€šè¿‡åè‡ªåŠ¨æ„å»ºæµ‹è¯•åŒ…ï¼ˆä»…åœ¨ agentrun ç›®å½•æœ‰å˜åŒ–æ—¶è§¦å‘ï¼‰
    - name: Get latest version from PyPI and calculate next version
      id: version
      if: steps.changes.outputs.agentrun_changed == 'true'
      run: |
        # ä» PyPI è·å– agentrun-inner-test çš„æœ€æ–°ç‰ˆæœ¬
        PYPI_RESPONSE=$(curl -s https://pypi.org/pypi/agentrun-inner-test/json 2>/dev/null || echo "")
        
        if [ -z "$PYPI_RESPONSE" ] || echo "$PYPI_RESPONSE" | grep -q "Not Found"; then
          # å¦‚æœåŒ…ä¸å­˜åœ¨ï¼Œä» 0.0.0 å¼€å§‹
          CURRENT_VERSION="0.0.0"
          echo "Package not found on PyPI, starting from 0.0.0"
        else
          # ä» PyPI å“åº”ä¸­æå–æœ€æ–°ç‰ˆæœ¬
          CURRENT_VERSION=$(echo "$PYPI_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
          echo "Latest version on PyPI: $CURRENT_VERSION"
        fi
        
        # è§£æç‰ˆæœ¬å·
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        # é»˜è®¤ä¸º patch
        BUMP_TYPE="patch"
        case "$BUMP_TYPE" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
        NEW_TAG="agentrun-inner-test-v${NEW_VERSION}"
        
        echo "VERSION=${NEW_VERSION}" >> $GITHUB_OUTPUT
        echo "TAG=${NEW_TAG}" >> $GITHUB_OUTPUT
        echo "New version: ${NEW_VERSION}"
        echo "New tag: ${NEW_TAG}"

    - name: Update package name and version in pyproject.toml
      if: steps.changes.outputs.agentrun_changed == 'true'
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        # ä¿®æ”¹åŒ…åä¸º agentrun-inner-test
        sed -i 's/name = "agentrun-sdk"/name = "agentrun-inner-test"/' pyproject.toml
        # ä¿®æ”¹ç‰ˆæœ¬å·
        sed -i 's/version = "[^"]*"/version = "'${VERSION}'"/' pyproject.toml
        echo "Updated pyproject.toml:"
        head -10 pyproject.toml

    - name: Update __version__ in __init__.py
      if: steps.changes.outputs.agentrun_changed == 'true'
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        if grep -q "__version__" agentrun/__init__.py; then
          sed -i 's/__version__ = "[^"]*"/__version__ = "'${VERSION}'"/' agentrun/__init__.py
        else
          sed -i '1a __version__ = "'${VERSION}'"' agentrun/__init__.py
        fi
        echo "Updated __init__.py version to ${VERSION}"
        grep "__version__" agentrun/__init__.py

    - name: Build package
      if: steps.changes.outputs.agentrun_changed == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        python -m build
        echo "Package built successfully"
        ls -la dist/

    - name: Verify package
      if: steps.changes.outputs.agentrun_changed == 'true'
      run: |
        python -m twine check dist/*
        echo "Package verification completed"

    - name: Publish to PyPI
      if: steps.changes.outputs.agentrun_changed == 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        verify-metadata: false

    - name: Create and push tag
      if: steps.changes.outputs.agentrun_changed == 'true'
      run: |
        TAG="${{ steps.version.outputs.TAG }}"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "$TAG" -m "Release test package version ${{ steps.version.outputs.VERSION }}"
        git push origin "$TAG"
        echo "Created and pushed tag: $TAG"

    - name: Summary
      if: steps.changes.outputs.agentrun_changed == 'true'
      run: |
        echo "## ğŸ‰ Test Package Released!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Package Name:** agentrun-inner-test" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag:** ${{ steps.version.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Install with: \`pip install agentrun-inner-test==${{ steps.version.outputs.VERSION }}\`" >> $GITHUB_STEP_SUMMARY

