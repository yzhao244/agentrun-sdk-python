name: Release Test Package

on:
  push:
    tags:
      - 'test-v*'

jobs:
  release-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Extract version from tag
      run: |
        TAG="${{ github.ref_name }}"
        # 从 test-v0.0.1 中提取 0.0.1
        VERSION="${TAG#test-v}"
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
        echo "Extracted version: ${VERSION}"

    - name: Update package name and version in pyproject.toml
      run: |
        # 修改包名为 agentrun-inner-test
        sed -i 's/name = "agentrun-sdk"/name = "agentrun-inner-test"/' pyproject.toml
        # 修改版本号
        sed -i 's/version = "[^"]*"/version = "'${VERSION}'"/' pyproject.toml
        echo "Updated pyproject.toml:"
        head -10 pyproject.toml

    - name: Update __version__ in __init__.py
      run: |
        if grep -q "__version__" agentrun/__init__.py; then
          sed -i 's/__version__ = "[^"]*"/__version__ = "'${VERSION}'"/' agentrun/__init__.py
        else
          sed -i '1a __version__ = "'${VERSION}'"' agentrun/__init__.py
        fi
        echo "Updated __init__.py version to ${VERSION}"
        grep "__version__" agentrun/__init__.py

    - name: Build package
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        python -m build
        echo "Package built successfully"
        ls -la dist/

    - name: Verify package
      run: |
        python -m twine check dist/*
        echo "Package verification completed"

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        verify-metadata: false

