name: Release Test Package

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œç”¨æˆ·å¯ä»¥åœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow"
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'ç‰ˆæœ¬é€’å¢ç±»å‹'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch   # 0.0.1 -> 0.0.2
          - minor   # 0.0.1 -> 0.1.0
          - major   # 0.0.1 -> 1.0.0

jobs:
  release-test:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–æ‰€æœ‰å†å²å’Œ tags

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Get latest version from PyPI and calculate next version
      id: version
      run: |
        # ä» PyPI è·å– agentrun-inner-test çš„æœ€æ–°ç‰ˆæœ¬
        PYPI_RESPONSE=$(curl -s https://pypi.org/pypi/agentrun-inner-test/json 2>/dev/null || echo "")
        
        if [ -z "$PYPI_RESPONSE" ] || echo "$PYPI_RESPONSE" | grep -q "Not Found"; then
          # å¦‚æœåŒ…ä¸å­˜åœ¨ï¼Œä» 0.0.0 å¼€å§‹
          CURRENT_VERSION="0.0.0"
          echo "Package not found on PyPI, starting from 0.0.0"
        else
          # ä» PyPI å“åº”ä¸­æå–æœ€æ–°ç‰ˆæœ¬
          CURRENT_VERSION=$(echo "$PYPI_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['info']['version'])")
          echo "Latest version on PyPI: $CURRENT_VERSION"
        fi
        
        # è§£æç‰ˆæœ¬å·
        IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
        
        # æ ¹æ®ç”¨æˆ·é€‰æ‹©é€’å¢ç‰ˆæœ¬
        BUMP_TYPE="${{ inputs.version_bump }}"
        case "$BUMP_TYPE" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
        esac
        
        NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
        NEW_TAG="agentrun-inner-test-v${NEW_VERSION}"
        
        echo "VERSION=${NEW_VERSION}" >> $GITHUB_OUTPUT
        echo "TAG=${NEW_TAG}" >> $GITHUB_OUTPUT
        echo "New version: ${NEW_VERSION}"
        echo "New tag: ${NEW_TAG}"

    - name: Update package name and version in pyproject.toml
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        # ä¿®æ”¹åŒ…åä¸º agentrun-inner-test
        sed -i 's/name = "agentrun-sdk"/name = "agentrun-inner-test"/' pyproject.toml
        # ä¿®æ”¹ç‰ˆæœ¬å·
        sed -i 's/version = "[^"]*"/version = "'${VERSION}'"/' pyproject.toml
        echo "Updated pyproject.toml:"
        head -10 pyproject.toml

    - name: Update __version__ in __init__.py
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        if grep -q "__version__" agentrun/__init__.py; then
          sed -i 's/__version__ = "[^"]*"/__version__ = "'${VERSION}'"/' agentrun/__init__.py
        else
          sed -i '1a __version__ = "'${VERSION}'"' agentrun/__init__.py
        fi
        echo "Updated __init__.py version to ${VERSION}"
        grep "__version__" agentrun/__init__.py

    - name: Build package
      run: |
        python -m pip install --upgrade pip
        pip install build twine
        python -m build
        echo "Package built successfully"
        ls -la dist/

    - name: Verify package
      run: |
        python -m twine check dist/*
        echo "Package verification completed"

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        verify-metadata: false

    - name: Create and push tag
      run: |
        TAG="${{ steps.version.outputs.TAG }}"
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "$TAG" -m "Release test package version ${{ steps.version.outputs.VERSION }}"
        git push origin "$TAG"
        echo "Created and pushed tag: $TAG"

    - name: Summary
      run: |
        echo "## ğŸ‰ Test Package Released!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Package Name:** agentrun-inner-test" >> $GITHUB_STEP_SUMMARY
        echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag:** ${{ steps.version.outputs.TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Install with: \`pip install agentrun-inner-test==${{ steps.version.outputs.VERSION }}\`" >> $GITHUB_STEP_SUMMARY
